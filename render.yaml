services:
  # Frontend Static Site (PRIMARY)
  - type: web
    name: phishing-detector-frontend
    env: static
    region: oregon
    plan: free
    branch: main
    buildCommand: echo "No build needed for static site"
    staticPublishPath: ./frontend
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600

  # Backend API Service
  - type: web
    name: phishing-detector-api
    env: python
    region: oregon
    plan: free  # KEEP: Free tier with optimizations
    branch: main
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && gunicorn --config gunicorn_config.py --workers 1 --threads 2 --max-requests 100 --max-requests-jitter 10 secure_api:app
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: APP_ENV
        value: production
      - key: DEBUG
        value: False
      - key: API_HOST
        value: 0.0.0.0
      - key: API_PORT
        value: 5000
      - key: API_BASE_URL
        generateValue: true
        sync: false
      - key: SECRET_KEY
        generateValue: true
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: SESSION_TIMEOUT_MINUTES
        value: 60
      - key: MAX_REQUESTS_PER_MINUTE
        value: 100
      - key: PHISHTANK_CACHE_HOURS
        value: 6
      - key: PYTHONUNBUFFERED
        value: "1"
      # Memory optimization for 512MB free tier
      - key: MEMORY_CONSTRAINT
        value: "512MB"
      - key: RENDER
        value: "true"
      - key: ENVIRONMENT
        value: "production"
      - key: FLASK_ENV
        value: "production"
      # Python memory optimization
      - key: PYTHONMALLOC
        value: "malloc"
      - key: MALLOC_TRIM_THRESHOLD_
        value: "65536"
    healthCheckPath: /health
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
